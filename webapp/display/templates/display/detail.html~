{% load staticfiles %}
<html>
    <head>
        <title>SlowControl</title>
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
	    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
	    <link rel="stylesheet" href="{% static 'css/monitor.css' %}"> 
	    <link rel="stylesheet" href="{% static 'css/detail.css' %}">

	    <meta charset='utf-8'>
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

        <!-- dygraph for ploting data and SavePlot.js for saving the plot -->
	    <script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.0/dygraph-combined.js"></script>
	    <script src="/static/java_scripts/SavePlot.js"></script>  <!-- saving plot to png -->


    <!------- date range picker from http://www.daterangepicker.com/ ------->
        <!-- Include Required Prerequisites -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/1/jquery.min.js"></script>
        <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
        <!-- Include Date Range Picker -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
        <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" /> 
        <!-- js for date range picker -->
        <script type="text/javascript">
        $(function() {
            $('input[name="daterange"]').daterangepicker({
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 30,
                ranges: {
                   'Last hour': [moment().subtract(1, 'hours'), moment()],
                   'Last 3 hours': [moment().subtract(3, 'hours'), moment()],
                   'Last Day': [moment().subtract(1, 'days'), moment()],
                   'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                   'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                },
                locale: {
                    format: 'MM/DD/YYYY hh:mm A'
                }
            });
        });
        </script>
    <!-- end date range picker from http://www.daterangepicker.com/ -->

    </head>

    <div id="headerBar"></div>

    <body>

    <!-- header bar with title -->
    <header>
	    <h1>SlowControl</h1>
	    <h2>{{config.controller}}</h2>
    </header>

	<!-- menu bar on left side -->
	<div id='cssmenu'>
		<ul>
		   <li><a href='/display/'><span>Home</span></a></li>
		   <li class='active has-sub'><a href='/display/'><span>Controllers</span></a>
			  <ul>
				{% if Config_list %}
					{% for config in Config_list %}
						<li class='last'><a href="/display/{{ config.controller }}/"><span>{{ config.controller }}</span></a></li>
					{% endfor %}
				{% else %}
					<p>No controllers are available.</p>
				{% endif %}
			  </ul>
		   </li>
		   <li><a href='/display/monitor/'><span>Monitor</span></a></li>
		</ul>

		<div class="box2" ></div>

		<ul>

		<!-- selection of data and timerange -->
			<form id="streamform" action="/display/{{config.controller}}/" method="post">
				{% csrf_token %}
			 <li><div class="styles"><font color="white">Select Data:</font>
				<select width="15px" name="dropdown1">
					<option value="{{ YaxisDj }}">{{ YaxisDj }}</option>
				{% for DataName in DataNames %}
					{% if  YaxisDj  !=  DataName  %} 
						<option value="{{ DataName }}">{{ DataName }}</option> 
					{% endif %}
				{% endfor %}
				</select>
			</div></li>
			<li><div class="styles"><font color="white">Select Time Range:</font>
				<input type="text" size="15" name="daterange" value="{{time_start_string}} - {{time_end_string}}"></input>
			</div></li>
			<li><div class="styles">
				<input type="submit" value="plot" id="streambutton"/>
			</div></li>
			</form>
		<!-- end selection of data and timerange -->

		<!-- save plot as png -->
		<li><a class="save_link" onclick="SavePlot()"><span>Save as png</span></a></li>

		<!-- save plot as csv -->
		<li><a class="save_link" onclick="SavePlotCSV()"><span>Save as csv</span></a></li>
		</ul>
	</div>
	<!-- end menu bar on left side -->

	<!-- main section -->
	<section>

        <!-- Table showing controller status/properties --> 
        <!--
		<div  id='overview_table' style="margin-right:10px; margin-left:0">
		 <table border="1" style="width:100%">
		  <tr>
			<td>status</td>
			<td>connection</td>
			<td>number of data</td>
			<td>readout interval</td>
			<td>address1</td>
			<td>address2</td>
			<td>alarm status</td>
			<td>warning low</td>
			<td>warning high</td>
			<td>alarm low</td>
			<td>alarm high</td>
			<td>description</td>
		  </tr>
		  <tr>
			<td>{{config.status}}</td>
			<td>{{config.connection}}</td>
			<td>{{config.number_of_data}}</td>
			<td>{{config.readout_interval}}</td>
			<td>{{config.address1}}</td>
			<td>{{config.address2}}</td>
			<td>{{config.alarm_status}}</td>
			<td>{{config.warning_low}}</td>
			<td>{{config.warning_high}}</td>
			<td>{{config.alarm_low}}</td>
			<td>{{config.alarm_high}}</td>
			<td>{{config.description}}</td>
		  </tr>
		</table> 
		</div>
		        -->

		<div  id='overview_table' style="margin-right:10px; margin-left:0">
		 <table border="1" style="width:100%">
		  <tr>
                {% for name, value in config.get_fields %}
                    {% if value %}
                      <td>{{ name }}</td>
                    {% endif %}
                {% endfor %}
		  </tr>
		  <tr>
                {% for name, value in config.get_fields %}
                    {% if value %}
                      <td>{{ value }}</td>
                    {% endif %}
                {% endfor %}		  
		  </tr>
		</table> 
		</div>
        <!-- end of Table --> 

       

        <!-- create container for plot --> 
		<p><div id="plot1" class="box"></div></p> 

	</section> 

    </body>


    <!----------- create the plot ----------->
    <script type="text/javascript">
	    var djangoData = {{ data|safe }};

        // prepare data for dygraph
	    var dateJ = new Array(djangoData.length);
	    for(var i = 0; i < djangoData.length; i++){
		    dateJ[i] = [new Date(djangoData[i][0]), djangoData[i][1] ];
	    }
	    if(djangoData.length==0)alert("Can't plot empty data set");

	    // The actual Dygraph constructor
	    chart = new Dygraph(
		    document.getElementById("plot1"),
		    dateJ,
		    {
			labels: [ "time","{{ YaxisDj }}" ],
	            	animatedZooms: true,
			legend: 'always',
			title: '{{config.controller}}/{{ YaxisDj }}',
			drawPoints: true,
			strokeWidth: 0,
			pointSize: 2
		    }
	    );

        //saveing the plot as png
        function SavePlot(){
              var imgExport = document.createElement('imgExport');
              Dygraph.Export.asPNG(chart,imgExport);
              window.location.href = imgExport.src.replace('image/png','image/octet-stream');
        }

	// save the plots as csv file
	function SavePlotCSV(){
	    var dateCSV = new Array(djangoData.length);
	    for(var i = 0; i < djangoData.length; i++){
		    dateCSV[i] = [djangoData[i][0], djangoData[i][1] ];
	    }
	    var csvString = dateCSV.join("%0A");
	    var a         = document.createElement('a');
	    a.href        = 'data:attachment/csv,' + csvString;
	    a.target      = '_blank';
	    a.download    = 'myFile.csv';
	    document.body.appendChild(a);
	    a.click();
	}
    </script>


</html>
